name: Lab Validation for PR

on:
  # Trigger when label is added to PR or new commits are pushed (if label exists)
  pull_request:
    types: [labeled, synchronize]

jobs:
  # Check if we should run based on trigger type
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
    - name: Check trigger conditions
      id: check
      run: |
        SHOULD_RUN="false"
        PR_NUMBER=""
        
        if [ "${{ github.event.action }}" = "labeled" ]; then
          # Check if 'lab-validation' label was added
          if [ "${{ github.event.label.name }}" = "lab-validation" ]; then
            SHOULD_RUN="true"
            PR_NUMBER="${{ github.event.number }}"
            echo "üè∑Ô∏è Label 'lab-validation' added to PR #$PR_NUMBER"
          fi
        elif [ "${{ github.event.action }}" = "synchronize" ]; then
          # Check if PR has 'lab-validation' label when new commits are pushed
          LABELS=$(gh api repos/batfish/batfish/pulls/${{ github.event.number }}/labels --jq '.[].name')
          if echo "$LABELS" | grep -q "lab-validation"; then
            SHOULD_RUN="true"
            PR_NUMBER="${{ github.event.number }}"
            echo "üîÑ New commits pushed to PR #$PR_NUMBER with 'lab-validation' label"
          fi
        fi
        
        echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
      env:
        GH_TOKEN: ${{ github.token }}

  # Get PR information for lab validation
  get-pr-info:
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    outputs:
      pr_ref: ${{ steps.get_pr.outputs.pr_ref }}
      pr_title: ${{ steps.get_pr.outputs.pr_title }}
    steps:
    - name: Get PR information
      id: get_pr
      run: |
        PR_DATA=$(gh api repos/batfish/batfish/pulls/${{ needs.check-trigger.outputs.pr_number }})
        PR_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
        PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
        echo "pr_ref=$PR_REF" >> $GITHUB_OUTPUT
        echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        echo "Testing PR #${{ needs.check-trigger.outputs.pr_number }}: $PR_TITLE"
        echo "Branch: $PR_REF"
      env:
        GH_TOKEN: ${{ github.token }}

  # Add PR comment before running lab validation  
  add-starting-comment:
    runs-on: ubuntu-latest
    needs: [check-trigger, get-pr-info]
    steps:
    - name: Add PR comment - Starting validation
      run: |
        gh api repos/batfish/batfish/issues/${{ needs.check-trigger.outputs.pr_number }}/comments \
          --method POST \
          --field body="üß™ **Lab Validation Started**

        Running lab validation for PR #${{ needs.check-trigger.outputs.pr_number }}: ${{ needs.get-pr-info.outputs.pr_title }}
        Branch: \`${{ needs.get-pr-info.outputs.pr_ref }}\`
        Testing: All available lab scenarios

        [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
      env:
        GH_TOKEN: ${{ github.token }}

  # Run lab validation using the PR branch
  lab-validation:
    needs: [check-trigger, get-pr-info, add-starting-comment]
    uses: batfish/lab-validation/.github/workflows/reusable-lab-validation.yml@main
    with:
      batfish_ref: ${{ needs.get-pr-info.outputs.pr_ref }}

  # Post results as PR comment
  post-results:
    runs-on: ubuntu-latest
    needs: [check-trigger, get-pr-info, add-starting-comment, lab-validation]
    if: always() && needs.check-trigger.outputs.should_run == 'true'  # Run even if lab validation fails, but only if we started
    steps:
    - name: Add PR comment - Results
      run: |
        if [ "${{ needs.lab-validation.result }}" == "success" ]; then
          STATUS="‚úÖ **Lab Validation Passed**"
          EMOJI="üéâ"
        else
          STATUS="‚ùå **Lab Validation Failed**"
          EMOJI="‚ö†Ô∏è"
        fi

        gh api repos/batfish/batfish/issues/${{ needs.check-trigger.outputs.pr_number }}/comments \
          --method POST \
          --field body="$EMOJI $STATUS

        PR #${{ needs.check-trigger.outputs.pr_number }}: ${{ needs.get-pr-info.outputs.pr_title }}
        Branch: \`${{ needs.get-pr-info.outputs.pr_ref }}\`
        Tested: All available lab scenarios

        [View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

        <details>
        <summary>How to interpret results</summary>

        - ‚úÖ **Success**: All lab tests passed against your changes
        - ‚ùå **Failure**: Some lab tests failed - check the workflow logs for details
        - Expected failures are tracked in sickbay files and should be listed in the logs

        If you see unexpected failures, your changes may have introduced a regression in Batfish's network modeling.
        </details>

        ---

        **üí° How to trigger lab validation:**
        Add the \`lab-validation\` label to this PR. Validation will rerun automatically when you push new commits."
      env:
        GH_TOKEN: ${{ github.token }}