name: Lab Validation for PR

on:
  # Trigger when label is added to PR
  pull_request:
    types: [labeled]
  # Trigger when someone comments on PR
  issue_comment:
    types: [created]

jobs:
  # Check if we should run based on trigger type
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      lab_filter: ${{ steps.check.outputs.lab_filter }}
    steps:
    - name: Check trigger conditions
      id: check
      run: |
        SHOULD_RUN="false"
        PR_NUMBER=""
        LAB_FILTER=""
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # Check if 'lab-validation' label was added
          if [ "${{ github.event.label.name }}" = "lab-validation" ]; then
            SHOULD_RUN="true"
            PR_NUMBER="${{ github.event.number }}"
            echo "üè∑Ô∏è Label 'lab-validation' added to PR #$PR_NUMBER"
          fi
        elif [ "${{ github.event_name }}" = "issue_comment" ]; then
          # Check if comment contains lab validation command
          COMMENT_BODY="${{ github.event.comment.body }}"
          if echo "$COMMENT_BODY" | grep -qE "^@github-actions? run lab-validation"; then
            # Only run on PRs, not issues
            if [ "${{ github.event.issue.pull_request.url }}" != "null" ]; then
              SHOULD_RUN="true"
              PR_NUMBER="${{ github.event.issue.number }}"
              echo "üí¨ Lab validation command found in comment on PR #$PR_NUMBER"
              
              # Extract lab filter if specified: "@github-actions run lab-validation eos_*"
              LAB_FILTER=$(echo "$COMMENT_BODY" | sed -n 's/^@github-actions run lab-validation \(.*\)/\1/p' | tr -d '\n\r')
              if [ -n "$LAB_FILTER" ]; then
                echo "üîç Lab filter: $LAB_FILTER"
              fi
            fi
          fi
        fi
        
        echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "lab_filter=$LAB_FILTER" >> $GITHUB_OUTPUT

  # Build Batfish JAR from the PR branch
  build-batfish:
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    outputs:
      pr_ref: ${{ steps.get_pr.outputs.pr_ref }}
      pr_title: ${{ steps.get_pr.outputs.pr_title }}
    steps:
    - name: Get PR information
      id: get_pr
      run: |
        PR_DATA=$(gh api repos/batfish/batfish/pulls/${{ needs.check-trigger.outputs.pr_number }})
        PR_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
        PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
        echo "pr_ref=$PR_REF" >> $GITHUB_OUTPUT
        echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        echo "Testing PR #${{ needs.check-trigger.outputs.pr_number }}: $PR_TITLE"
        echo "Branch: $PR_REF"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.get_pr.outputs.pr_ref }}
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Bazelisk cache
      uses: actions/cache@v4
      with:
        path: "~/.cache/bazelisk"
        key: ${{runner.os}}-bazelisk-${{ hashFiles('.bazelversion') }}
    
    - name: Bazel cache
      uses: actions/cache@v4
      with:
        path: "~/.cache/bazel"
        key: ${{runner.os}}-bazel-17-${{ hashFiles('.bazelversion', 'WORKSPACE', 'maven_install.json') }}-${{ github.run_id }}
        restore-keys: |
          ${{runner.os}}-bazel-17-${{ hashFiles('.bazelversion', 'WORKSPACE', 'maven_install.json') }}-

    - name: Build Batfish JAR and questions
      run: |
        bazel build //projects/allinone:allinone_main_deploy.jar
        cp bazel-bin/projects/allinone/allinone_main_deploy.jar allinone.jar
        # Create questions archive following pybatfish pattern
        tar -czf questions.tgz questions/

    - name: Upload Batfish artifacts
      uses: actions/upload-artifact@v4
      with:
        name: batfish-pr-artifacts
        path: |
          allinone.jar
          questions.tgz
        retention-days: 1

  # Run lab validation using the built JAR
  lab-validation:
    runs-on: ubuntu-latest
    needs: [check-trigger, build-batfish]
    steps:
    - name: Add PR comment - Starting validation
      run: |
        gh api repos/batfish/batfish/issues/${{ needs.check-trigger.outputs.pr_number }}/comments \
          --method POST \
          --field body="üß™ **Lab Validation Started**

        Running lab validation for PR #${{ needs.check-trigger.outputs.pr_number }}: ${{ needs.build-batfish.outputs.pr_title }}
        Branch: \`${{ needs.build-batfish.outputs.pr_ref }}\`
        Filter: ${{ needs.check-trigger.outputs.lab_filter || 'All labs' }}

        [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run lab validation
      uses: batfish/lab-validation/.github/workflows/reusable-lab-validation.yml@main
      with:
        batfish_ref: ${{ needs.build-batfish.outputs.pr_ref }}
        lab_filter: ${{ needs.check-trigger.outputs.lab_filter }}

  # Post results as PR comment
  post-results:
    runs-on: ubuntu-latest
    needs: [check-trigger, build-batfish, lab-validation]
    if: always() && needs.check-trigger.outputs.should_run == 'true'  # Run even if lab validation fails, but only if we started
    steps:
    - name: Add PR comment - Results
      run: |
        if [ "${{ needs.lab-validation.result }}" == "success" ]; then
          STATUS="‚úÖ **Lab Validation Passed**"
          EMOJI="üéâ"
        else
          STATUS="‚ùå **Lab Validation Failed**"
          EMOJI="‚ö†Ô∏è"
        fi

        gh api repos/batfish/batfish/issues/${{ needs.check-trigger.outputs.pr_number }}/comments \
          --method POST \
          --field body="$EMOJI $STATUS

        PR #${{ needs.check-trigger.outputs.pr_number }}: ${{ needs.build-batfish.outputs.pr_title }}
        Branch: \`${{ needs.build-batfish.outputs.pr_ref }}\`
        Filter: ${{ needs.check-trigger.outputs.lab_filter || 'All labs' }}

        [View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

        <details>
        <summary>How to interpret results</summary>

        - ‚úÖ **Success**: All lab tests passed against your changes
        - ‚ùå **Failure**: Some lab tests failed - check the workflow logs for details
        - Expected failures are tracked in sickbay files and should be listed in the logs

        If you see unexpected failures, your changes may have introduced a regression in Batfish's network modeling.
        </details>

        ---

        **üí° How to trigger lab validation:**
        - Add the \`lab-validation\` label to this PR, or
        - Comment: \`@github-actions run lab-validation\` (optionally with filter like \`@github-actions run lab-validation eos_*\`)"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}