name: Lab Validation for PR

on:
  # Trigger when label is added to PR or new commits are pushed (if label exists)
  pull_request:
    types: [labeled, synchronize]

jobs:
  # Check if we should run based on trigger type
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
    - name: Check trigger conditions
      id: check
      run: |
        SHOULD_RUN="false"
        PR_NUMBER=""
        
        if [ "${{ github.event.action }}" = "labeled" ]; then
          # Check if 'lab-validation' label was added
          if [ "${{ github.event.label.name }}" = "lab-validation" ]; then
            SHOULD_RUN="true"
            PR_NUMBER="${{ github.event.number }}"
            echo "üè∑Ô∏è Label 'lab-validation' added to PR #$PR_NUMBER"
          fi
        elif [ "${{ github.event.action }}" = "synchronize" ]; then
          # Check if PR has 'lab-validation' label when new commits are pushed
          LABELS=$(gh api repos/batfish/batfish/pulls/${{ github.event.number }}/labels --jq '.[].name')
          if echo "$LABELS" | grep -q "lab-validation"; then
            SHOULD_RUN="true"
            PR_NUMBER="${{ github.event.number }}"
            echo "üîÑ New commits pushed to PR #$PR_NUMBER with 'lab-validation' label"
          fi
        fi
        
        echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

  # Build Batfish JAR from the PR branch
  build-batfish:
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    outputs:
      pr_ref: ${{ steps.get_pr.outputs.pr_ref }}
      pr_title: ${{ steps.get_pr.outputs.pr_title }}
    steps:
    - name: Get PR information
      id: get_pr
      run: |
        PR_DATA=$(gh api repos/batfish/batfish/pulls/${{ needs.check-trigger.outputs.pr_number }})
        PR_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
        PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
        echo "pr_ref=$PR_REF" >> $GITHUB_OUTPUT
        echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
        echo "Testing PR #${{ needs.check-trigger.outputs.pr_number }}: $PR_TITLE"
        echo "Branch: $PR_REF"
    
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.get_pr.outputs.pr_ref }}
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Bazelisk cache
      uses: actions/cache@v4
      with:
        path: "~/.cache/bazelisk"
        key: ${{runner.os}}-bazelisk-${{ hashFiles('.bazelversion') }}
    
    - name: Bazel cache
      uses: actions/cache@v4
      with:
        path: "~/.cache/bazel"
        key: ${{runner.os}}-bazel-17-${{ hashFiles('.bazelversion', 'WORKSPACE', 'maven_install.json') }}-${{ github.run_id }}
        restore-keys: |
          ${{runner.os}}-bazel-17-${{ hashFiles('.bazelversion', 'WORKSPACE', 'maven_install.json') }}-

    - name: Build Batfish JAR and questions
      run: |
        bazel build //projects/allinone:allinone_main_deploy.jar
        cp bazel-bin/projects/allinone/allinone_main_deploy.jar allinone.jar
        # Create questions archive following pybatfish pattern
        tar -czf questions.tgz questions/

    - name: Upload Batfish artifacts
      uses: actions/upload-artifact@v4
      with:
        name: batfish-pr-artifacts
        path: |
          allinone.jar
          questions.tgz
        retention-days: 1

  # Add PR comment before running lab validation  
  add-starting-comment:
    runs-on: ubuntu-latest
    needs: [check-trigger, build-batfish]
    steps:
    - name: Add PR comment - Starting validation
      run: |
        gh api repos/batfish/batfish/issues/${{ needs.check-trigger.outputs.pr_number }}/comments \
          --method POST \
          --field body="üß™ **Lab Validation Started**

        Running lab validation for PR #${{ needs.check-trigger.outputs.pr_number }}: ${{ needs.build-batfish.outputs.pr_title }}
        Branch: \`${{ needs.build-batfish.outputs.pr_ref }}\`
        Testing: All available lab scenarios

        [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

  # Run lab validation using the built JAR
  lab-validation:
    needs: [check-trigger, build-batfish, add-starting-comment]
    uses: batfish/lab-validation/.github/workflows/reusable-lab-validation.yml@main
    with:
      batfish_ref: ${{ needs.build-batfish.outputs.pr_ref }}

  # Post results as PR comment
  post-results:
    runs-on: ubuntu-latest
    needs: [check-trigger, build-batfish, add-starting-comment, lab-validation]
    if: always() && needs.check-trigger.outputs.should_run == 'true'  # Run even if lab validation fails, but only if we started
    steps:
    - name: Add PR comment - Results
      run: |
        if [ "${{ needs.lab-validation.result }}" == "success" ]; then
          STATUS="‚úÖ **Lab Validation Passed**"
          EMOJI="üéâ"
        else
          STATUS="‚ùå **Lab Validation Failed**"
          EMOJI="‚ö†Ô∏è"
        fi

        gh api repos/batfish/batfish/issues/${{ needs.check-trigger.outputs.pr_number }}/comments \
          --method POST \
          --field body="$EMOJI $STATUS

        PR #${{ needs.check-trigger.outputs.pr_number }}: ${{ needs.build-batfish.outputs.pr_title }}
        Branch: \`${{ needs.build-batfish.outputs.pr_ref }}\`
        Tested: All available lab scenarios

        [View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

        <details>
        <summary>How to interpret results</summary>

        - ‚úÖ **Success**: All lab tests passed against your changes
        - ‚ùå **Failure**: Some lab tests failed - check the workflow logs for details
        - Expected failures are tracked in sickbay files and should be listed in the logs

        If you see unexpected failures, your changes may have introduced a regression in Batfish's network modeling.
        </details>

        ---

        **üí° How to trigger lab validation:**
        Add the \`lab-validation\` label to this PR. Validation will rerun automatically when you push new commits."