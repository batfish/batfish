language: java
sudo: true

jdk:
  - oraclejdk8

env:
  matrix:
    - BF_BUILDER="mvn"
    - BF_BUILDER="bazel" V="0.13.0"

before_install:
  - .travis/fix_java_format.sh
  - |
    if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then
      OS=darwin
    else
      sysctl kernel.unprivileged_userns_clone=1
      OS=linux
    fi
    if [[ "${V}" == "HEAD" ]]; then
      # Determine last successful build number. This may change while we are
      # downloading, so it's important to determine ahead of time, in case
      # we need to resume the download.
      CI_BASE="https://ci.bazel.io/view/Bazel%20bootstrap%20and%20maintenance/job/Bazel/PLATFORM_NAME=${OS}-x86_64/"
      CI_INDEX_URL="${CI_BASE}/lastSuccessfulBuild/"
      wget -q -O build-index.html "${CI_INDEX_URL}"
      CI_BUILD=$(grep '<title>' build-index.html | sed -e 's/^.*#\([0-9]*\).*$/\1/')
      # Determine the artifact name. This is normally, bazel--installer.sh,
      # but it may be, for example, bazel-0.5rc2-installer.sh before a release.
      CI_ARTIFACT=$(grep -o 'bazel-[^\"-]*-installer.sh' build-index.html | head -n 1)
      URL="${CI_BASE}/${CI_BUILD}/artifact/output/ci/${CI_ARTIFACT}"
      rm build-index.html
    else
      URL="https://github.com/bazelbuild/bazel/releases/download/${V}/bazel-${V}-installer-${OS}-x86_64.sh"
    fi
    wget -O install.sh "${URL}"
    chmod +x install.sh
    ./install.sh --user
    rm -f install.sh

install:
  - .travis/install.sh

script:
  - if [ ${BF_BUILDER} == "mvn" ]; then .travis/build.sh ; fi
  - if [ ${BF_BUILDER} == "bazel" ]; then bazel build '...' ; fi


# Cache the Maven dependencies installed.
cache:
  directories:
  - $HOME/.m2
  - $HOME/.batfish_z3_cache

# Delete the batfish jars, which change every build, from the cache.
# Also delete the locally-built jars, which are installed every build.
#
# Otherwise the cache would be detected as updated every time.
before_cache:
  - rm -rf $HOME/.m2/repository/com/jayway/jsonpath/json-path/
  - rm -rf $HOME/.m2/repository/com/kjetland/mbknor-jackson-jsonschema_2.12/
  - rm -rf $HOME/.m2/repository/com/microsoft/z3/z3/
  - rm -rf $HOME/.m2/repository/net/sf/javabdd/bdd/
  - rm -rf $HOME/.m2/repository/org/batfish
